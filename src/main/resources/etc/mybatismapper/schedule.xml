<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="schedule">

	<cache />


	<!-- SELECT FOR VERIFY AND REVIEW SHIP (BOP) -->
	<select id="reviewShipWork" parameterType="map"
		resultType="org.uario.seaworkengine.model.ReviewShipWork">

		select ss.id as rif_sws, ss.rif_mct,
		s.name as shipname,
		s.id as
		id_ship,
		dss.shift,
		d.timework as time_work,
		d.crane, d.crane_gtw,
		dss.shiftdate as date_request,
		d.volume,
		d.volumeunderboard,
		d.volumeunderboard_sws,
		d.volume_tw_mct,
		d.notedetail, d.invoicing_cycle
		from
		ship s,
		scheduleship ss,
		detailscheduleship dss
		left join
		detailfinalscheduleship d ON (dss.id = d.iddetailscheduleship)
		where
		dss.idscheduleship = ss.id
		and s.id = ss.idship

		<if test="dt_arg_to != null">
			<if test="dt_arg_from != null">
				and dss.shiftdate <![CDATA[>=]]>
				#{dt_arg_from} and
				dss.shiftdate <![CDATA[<=]]>
				#{dt_arg_to}
			</if>
		</if>
		
		<if test="dt_arg_to == null">
			<if test="dt_arg_from != null">
				and dss.shiftdate = #{dt_arg_from}
			</if>
		</if>

		<if test="searchText != null">
			and s.name like CONCAT('%', #{searchText},'%')
		</if>


		<if test="rifSWS != null">
			and ss.id = #{rifSWS}
		</if>

		<if test="rifMCT != null">
			and ss.rif_mct = #{rifMCT}
		</if>


		order by s.name , date_request, dss.shift
	</select>


	<select id="loadScheduleByDate" parameterType="map"
		resultType="org.uario.seaworkengine.model.Schedule">
		SELECT id, date_schedule, user, note, editor, controller,
		shift, sync_mobile
		FROM schedule
		WHERE date_schedule = #{dt_arg};
	</select>

	<select id="loadScheduleById" parameterType="Integer"
		resultType="org.uario.seaworkengine.model.Schedule">
		SELECT id, date_schedule, user, note, editor, controller,
		shift, sync_mobile
		FROM schedule
		WHERE id = #{id};
	</select>




	<select id="selectSchedulersForPreprocessingOnUserId"
		resultType="org.uario.seaworkengine.model.Schedule" parameterType="map">


		select s.id,
		u.id as user,
		s.shift,
		s.date_schedule, s.sync_mobile,
		concat(u.lastname, ' ', u.firstname) AS name_user
		from
		user u left join
		schedule s ON (u.id =
		s.user and s.date_schedule <![CDATA[>=]]>
		#{date_from} and
		s.date_schedule <![CDATA[<]]>
		#{date_to})
		where u.id = #{userid}
		order by u.lastname asc

	</select>


	<select id="selectSchedulersForPreprocessing" resultType="org.uario.seaworkengine.model.Schedule"
		parameterType="map">

		select s.id,
		u.id as user,
		s.shift,
		s.date_schedule, s.sync_mobile,
		concat(u.lastname, ' ', u.firstname) AS name_user
		from
		user u left join
		schedule s ON (u.id =
		s.user and s.date_schedule <![CDATA[>=]]>
		#{date_from} and
		s.date_schedule <![CDATA[<]]>
		#{date_to})
		where u.status <![CDATA[<>]]>
		'LICENZIATO' and u.status <![CDATA[<>]]>
		'SOSPESO' and u.out_schedule = 0

		<if test="my_full_text_search != null">
			and (u.firstname like CONCAT('%', #{my_full_text_search},
			'%') or
			u.lastname
			like
			CONCAT('%', #{my_full_text_search},'%') or
			u.employee_identification = #{my_full_text_search})
		</if>

		order by u.lastname asc

	</select>


	<insert id="createSchedule" parameterType="org.uario.seaworkengine.model.Schedule">
		INSERT INTO
		schedule
		(date_schedule, user, editor, controller, note,shift, sync_mobile)
		VALUES
		(#{date_schedule}, #{user}, #{editor}, #{controller},
		#{note},
		#{shift},#{sync_mobile});
	</insert>



	<update id="updateSchedule" parameterType="org.uario.seaworkengine.model.Schedule">
		UPDATE schedule
		SET
		id =
		#{id},
		date_schedule = #{date_schedule},
		user = #{user},
		editor =
		#{editor},
		controller = #{controller},
		note = #{note},
		shift = #{shift}
		WHERE id = #{id};
	</update>

	<update id="updateMobileSynch" parameterType="boolean">
		UPDATE schedule
		SET
		sync_mobile = #{sync_mobile}
		WHERE id = #{id};
	</update>


	<select id="getLastShiftProgram" parameterType="map" resultType="int">
		select max(dfs.shift)
		from detailinitialschedule dfs, schedule s
		where
		s.user = #{id_user} and
		s.id = dfs.id_schedule and s.date_schedule =
		#{date_schedule}
	</select>

	<select id="getLastShiftRevision" parameterType="map"
		resultType="int">
		select
		max(dfs.shift)
		from detailfinalschedule dfs, schedule
		s
		where s.user = #{id_user} and s.id = dfs.id_schedule and
		s.date_schedule = #{date_schedule}
	</select>

	<select id="getFirstShiftProgram" parameterType="map"
		resultType="int">
		select min(dfs.shift)
		from detailinitialschedule dfs,
		schedule s
		where
		s.user = #{id_user} and
		s.id = dfs.id_schedule and
		s.date_schedule =
		#{date_schedule}
	</select>

	<select id="getFirstShiftRevision" parameterType="map"
		resultType="int">
		select
		min(dfs.shift)
		from detailfinalschedule dfs, schedule
		s
		where s.user = #{id_user} and s.id = dfs.id_schedule and
		s.date_schedule = #{date_schedule}
	</select>

	<select id="selectScheduleByDateAndUser" resultType="org.uario.seaworkengine.model.Schedule"
		parameterType="map">
		SELECT s.id, s.date_schedule, s.user, s.editor,
		s.controller,
		s.shift,s.note,s.sync_mobile
		FROM schedule s
		WHERE s.user =
		#{id_user}
		and
		s.date_schedule =
		#{date_schedule};
	</select>

	<delete id="removeScheduleByDateAndUser" parameterType="map">
		DELETE
		FROM
		schedule
		WHERE
		user = #{id_user} and
		date_schedule =
		#{date_schedule};
	</delete>

	<select id="selectScheduleInIntervalDateByUserId" parameterType="map"
		resultType="org.uario.seaworkengine.model.Schedule">
		SELECT id, date_schedule, user, note, editor, controller,
		shift, sync_mobile
		FROM schedule
		WHERE user=#{user} and date_schedule >=
		#{date_from} and #{date_to} >= date_schedule order by date_schedule
		asc;
	</select>

	<select id="selectAggregateScheduleProgram" resultType="org.uario.seaworkengine.model.Schedule"
		parameterType="map">

		select
		s.id,
		s.shift, s.sync_mobile,
		ds.shift as no_shift,
		sum(ds.time) as
		program_time,
		s.date_schedule,
		s.note,
		s.editor,
		s.controller,
		u.id as
		user,
		concat(u.lastname, ' ', u.firstname) AS name_user
		from
		user u,
		schedule s
		left join
		detailinitialschedule ds ON
		(s.id = ds.id_schedule)
		where
		u.id
		= s.user
		and s.date_schedule >=
		#{date_from} and
		s.date_schedule <![CDATA[<]]>
		#{date_to} and u.status <![CDATA[<>]]>
		'LICENZIATO' and u.status <![CDATA[<>]]>
		'SOSPESO' and u.out_schedule = 0

		<if test="my_full_text_search != null">
			and (u.firstname like CONCAT('%',
			#{my_full_text_search},'%') or
			u.lastname
			like
			CONCAT('%',
			#{my_full_text_search}, '%') or
			u.employee_identification =
			#{my_full_text_search})
		</if>

		group by user , s.id , no_shift
		order by user, s.date_schedule asc

	</select>

	<select id="selectAggregateScheduleRevision" resultType="org.uario.seaworkengine.model.Schedule"
		parameterType="map">

		select
		s.id,
		s.shift, s.sync_mobile,
		ds.shift as no_shift,
		sum(ds.time) as
		revision_time,
		s.date_schedule,
		s.note,
		s.editor,
		s.controller,
		u.id as
		user,
		concat(u.lastname, ' ', u.firstname) AS name_user
		from
		user u,
		schedule s
		left join
		detailfinalschedule ds ON (s.id = ds.id_schedule)
		where
		u.id =
		s.user
		and
		s.date_schedule >= #{date_from} and
		s.date_schedule  <![CDATA[<]]>
		#{date_to}
		and u.status <![CDATA[<>]]>
		'LICENZIATO' and u.status  <![CDATA[<>]]>
		'SOSPESO' and u.out_schedule = 0

		<if test="my_full_text_search != null">
			and (u.firstname like CONCAT('%',
			#{my_full_text_search},'%') or
			u.lastname
			like
			CONCAT('%',
			#{my_full_text_search},'%') or
			u.employee_identification =
			#{my_full_text_search})
		</if>

		group by user , s.id , no_shift
		order by user, s.date_schedule
		asc

	</select>

	<select id="selectAggregateScheduleByDateProgram" resultType="org.uario.seaworkengine.model.Schedule"
		parameterType="map">

		select
		s.id,
		s.shift, s.sync_mobile,
		ds.shift as no_shift,
		sum(ds.time) as
		program_time,
		s.date_schedule,
		s.note,
		s.editor,
		s.controller,
		u.id as
		user,
		concat(u.lastname, ' ', u.firstname) AS name_user
		from
		user u,
		schedule s
		left join
		detailinitialschedule ds ON (s.id = ds.id_schedule)
		where
		u.id
		= s.user
		and s.date_schedule = #{date_from} and u.status <![CDATA[<>]]>
		'LICENZIATO' and u.status <![CDATA[<>]]>
		'SOSPESO' and u.out_schedule = 0

		<if test="my_full_text_search != null">
			and (u.firstname like CONCAT('%', #{my_full_text_search},
			'%') or
			u.lastname
			like
			CONCAT('%', #{my_full_text_search}, '%') or
			u.employee_identification = #{my_full_text_search})
		</if>


		group by user , s.id , no_shift
		order by user, s.date_schedule asc

	</select>

	<select id="selectAggregateScheduleByDateRevision" resultType="org.uario.seaworkengine.model.Schedule"
		parameterType="map">

		select
		s.id,
		s.shift, s.sync_mobile,
		ds.shift as no_shift,
		sum(ds.time) as
		revision_time,
		s.date_schedule,
		s.note,
		s.editor,
		s.controller,
		u.id as
		user,
		concat(u.lastname, ' ', u.firstname) AS name_user
		from
		user u,
		schedule s
		left join
		detailfinalschedule ds ON (s.id = ds.id_schedule)
		where
		u.id =
		s.user
		and
		s.date_schedule = #{date_from} and u.status <![CDATA[<>]]>
		'LICENZIATO' and u.status <![CDATA[<>]]>
		'SOSPESO' and u.out_schedule = 0

		<if test="my_full_text_search != null">
			and (u.firstname like CONCAT('%',
			#{my_full_text_search},'%') or
			u.lastname
			like
			CONCAT('%',
			#{my_full_text_search}, '%') or
			u.employee_identification =
			#{my_full_text_search})
		</if>


		group by user , s.id , no_shift
		order by user, s.date_schedule asc

	</select>


	<insert id="createDetailInitialSchedule" parameterType="org.uario.seaworkengine.model.DetailInitialSchedule">
		INSERT
		INTO
		detailinitialschedule (id_schedule, shift,
		task,time,time_from,time_to, time_vacation)
		VALUES
		(#{id_schedule},
		#{shift},#{task}, #{time}, #{time_from},#{time_to},#{time_vacation});
	</insert>

	<insert id="createDetailFinalSchedule" parameterType="org.uario.seaworkengine.model.DetailFinalSchedule">
		INSERT INTO
		detailfinalschedule (id_schedule, shift, task, time, time_from,
		time_to, time_vacation, id_ship, crane, board)
		VALUES
		(#{id_schedule},#{shift},#{task},#{time},#{time_from},#{time_to},
		#{time_vacation}, #{id_ship}, #{crane}, #{board});
	</insert>



	<select id="loadDetailInitialScheduleByIdScheduleAndShift"
		resultType="org.uario.seaworkengine.model.DetailInitialSchedule"
		parameterType="map">
		SELECT id, id_schedule, shift, task, time, time_from,
		time_to, time_vacation
		FROM
		detailinitialschedule
		WHERE id_schedule =
		#{id_schedule} and shift =
		#{shift};
	</select>

	<select id="loadDetailFinalScheduleByIdScheduleAndShift"
		resultType="org.uario.seaworkengine.model.DetailFinalSchedule"
		parameterType="map">
		SELECT df.id, df.id_schedule, df.shift, df.task,
		df.time, df.time_from,
		df.time_to, df.time_vacation, df.id_ship,
		df.crane, s.name as nameShip, df.board
		FROM detailfinalschedule df LEFT
		JOIN ship
		s ON df.id_ship = s.id
		WHERE
		df.id_schedule =
		#{id_schedule} and
		df.shift = #{shift};
	</select>

	<select id="loadDetailInitialScheduleByIdSchedule"
		parameterType="Integer" resultType="org.uario.seaworkengine.model.DetailInitialSchedule">
		SELECT id, id_schedule, shift,
		task, time, time_from, time_to, time_vacation
		FROM
		detailinitialschedule
		WHERE id_schedule =
		#{id_schedule}
	</select>

	<select id="loadDetailInitialScheduleForMobileByIdSchedule"
		parameterType="Integer" resultType="org.uario.seaworkengine.model.DetailInitialSchedule">
		SELECT d.id, d.id_schedule,
		d.shift,
		d.task, d.time, d.time_from, d.time_to, d.time_vacation,
		concat(ut.code,' - ',ut.description) as task_mobile_desc
		FROM
		detailinitialschedule d, usertask ut
		WHERE ut.hiddenoperative = 0 and id_schedule =
		#{id_schedule}
		and d.task = ut.id
	</select>

	<!-- LOAD THE FINAL INFO IN INITIAL STRUCTURE -->
	<select id="loadDetailFinalScheduleForMobileByIdSchedule"
		parameterType="Integer" resultType="org.uario.seaworkengine.model.DetailInitialSchedule">
		SELECT d.id, d.id_schedule,
		d.shift,
		d.task, d.time, d.time_from, d.time_to, d.time_vacation,
		concat(ut.code,' - ',ut.description) as task_mobile_desc
		FROM
		detailfinalschedule d, usertask ut
		WHERE ut.hiddenoperative = 0  and id_schedule =
		#{id_schedule}
		and d.task = ut.id
	</select>




	<select id="loadDetailFinalScheduleByIdSchedule" parameterType="Integer"
		resultType="org.uario.seaworkengine.model.DetailFinalSchedule">
		SELECT df.id, df.id_schedule, df.shift, df.task, df.time,
		df.time_from,
		df.time_to, df.time_vacation, df.id_ship, df.crane,
		df.board,
		s.name as nameShip
		FROM detailfinalschedule df LEFT JOIN ship
		s ON
		df.id_ship
		= s.id
		WHERE
		id_schedule =
		#{id_schedule};
	</select>


	<delete id="removeAllDetailInitialScheduleByScheduleAndShift"
		parameterType="map">
		DELETE FROM
		detailinitialschedule
		WHERE id_schedule =
		#{id_schedule} and shift
		= #{shift};
	</delete>

	<delete id="removeAllDetailFinalScheduleByScheduleAndShift"
		parameterType="map">
		DELETE FROM
		detailfinalschedule
		WHERE id_schedule =
		#{id_schedule} and shift
		= #{shift};
	</delete>






	<delete id="removeAllDetailInitialScheduleBySchedule"
		parameterType="map">
		DELETE FROM
		detailinitialschedule
		WHERE id_schedule =
		#{id_schedule};
	</delete>

	<delete id="removeAllDetailFinalScheduleBySchedule"
		parameterType="map">
		DELETE FROM
		detailfinalschedule
		WHERE id_schedule =
		#{id_schedule};
	</delete>

	<delete id="removeScheduleUser" parameterType="map">
		<![CDATA[
		DELETE FROM
		schedule
		WHERE user=#{idUser} and date_schedule>=#{initialDate} and #{finalDate}>=date_schedule;
		]]>
	</delete>


	<delete id="removeScheduleUserFired" parameterType="map">
		<![CDATA[
		DELETE FROM
		schedule
		WHERE user=#{idUser} and date_schedule>=#{firedDate};
		]]>
	</delete>








</mapper>	
	

	
	
	
