<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="statistics">

	<cache-ref namespace="schedule" />



	<select id="listSchedule" resultType="org.uario.seaworkengine.model.Schedule"
		parameterType="map">

		select s.id,
		u.id as user,
		s.shift,
		s.date_schedule,
		concat(u.lastname, '
		', u.firstname) AS name_user,
		s.editor,
		s.controller
		from
		user u,
		schedule
		s
		where (u.id =
		s.user)

		<if test="date_from != null and date_to != null">
			and (s.date_schedule <![CDATA[>=]]>
			#{date_from} and s.date_schedule
			<![CDATA[<=]]>
			#{date_to})
		</if>

		<if test="my_full_text_search != null">
			and (u.firstname like CONCAT('%', #{my_full_text_search},
			'%') or
			u.lastname like CONCAT('%', #{my_full_text_search}, '%') or
			u.employee_identification = #{my_full_text_search})
		</if>

		<if test="date_from != null and date_to != null">
			and (s.date_schedule <![CDATA[>=]]>
			#{date_from} and s.date_schedule
			<![CDATA[<=]]>
			#{date_to})
		</if>

		<if test="shift_number != null">
			and (s.shift = #{shift_number})
		</if>

		order by u.lastname asc, s.date_schedule
	</select>

	<select id="overviewGlobal"
		resultType="org.uario.seaworkengine.statistics.beans.GlobalProgramResult"
		parameterType="map">
		select
		s.id as id_schedule,
		s.date_schedule,
		concat(u.lastname, ' ',
		u.firstname) as user,
		s.note,
		s.editor,
		s.controller,
		s.shift,
		dis.shift as
		program_shift_no,
		dis.task as program_task,
		dis.time as program_time,
		dfs.shift as review_shift_no,
		dfs.task as review_task,
		dfs.time as
		review_time,
		dfs.time_from as entry,
		dfs.time_to exit_out
		from
		schedule s
		left outer join
		detailinitialschedule dis ON s.id = dis.id_schedule
		left outer join
		detailfinalschedule dfs ON s.id = dfs.id_schedule, user
		u
		where s.user = u.id

		<if test="my_full_text_search != null">
			and (u.firstname like CONCAT('%', #{my_full_text_search},
			'%') or
			u.lastname like CONCAT('%', #{my_full_text_search}, '%') or
			u.employee_identification = #{my_full_text_search})
		</if>

		<if test="date_from != null and date_to != null">
			and (s.date_schedule <![CDATA[>=]]>
			#{date_from} and s.date_schedule
			<![CDATA[<=]]>
			#{date_to})
		</if>

		<if test="shift_number != null">
			and (s.shift = #{shift_number})
		</if>

		order by u.lastname asc, s.date_schedule


	</select>



	<select id="overviewFinalSchedule" resultType="org.uario.seaworkengine.model.DetailFinalSchedule"
		parameterType="map">
		select
		concat(u.lastname, ' ', u.firstname) as user,
		dfs.id,
		dfs.id_schedule,
		dfs.shift,
		dfs.task,
		dfs.time,
		dfs.time_from,
		dfs.time_to,
		s.date_schedule
		from
		detailfinalschedule dfs,
		schedule s,
		user u
		where
		dfs.id_schedule =
		s.id and s.user = u.id

		<if test="my_full_text_search != null">
			and (u.firstname like CONCAT('%', #{my_full_text_search},
			'%') or
			u.lastname like CONCAT('%', #{my_full_text_search}, '%') or
			u.employee_identification = #{my_full_text_search})
		</if>

		<if test="shift_number != null">
			and (dfs.shift = #{shift_number})
		</if>

		<if test="date_from != null and date_to != null">
			and (s.date_schedule <![CDATA[>=]]>
			#{date_from} and s.date_schedule
			<![CDATA[<=]]>
			#{date_to})
		</if>

		order by u.lastname, s.date_schedule, dfs.shift asc

	</select>

	<select id="overviewInitalSchedule" resultType="org.uario.seaworkengine.model.DetailInitialSchedule"
		parameterType="map">
		select
		concat(u.lastname, ' ', u.firstname) as user,
		dfs.id,
		dfs.id_schedule,
		dfs.shift,
		dfs.task,
		dfs.time,
		s.date_schedule
		from
		detailinitialschedule
		dfs,
		schedule s,
		user u
		where
		dfs.id_schedule = s.id
		and s.user = u.id

		<if test="my_full_text_search != null">
			and (u.firstname like CONCAT('%', #{my_full_text_search},
			'%') or
			u.lastname like CONCAT('%', #{my_full_text_search}, '%') or
			u.employee_identification = #{my_full_text_search})
		</if>

		<if test="shift_number != null">
			and (dfs.shift = #{shift_number})
		</if>

		order by u.lastname, s.date_schedule, dfs.shift asc

	</select>





	<select id="datesBreak" resultType="java.util.Date"
		parameterType="map">
		select
		max(d.date_schedule) as date_break
		from
		schedule d,
		usershift s
		where
		d.date_schedule <![CDATA[>=]]>
		#{date_schedule_from}
		and d.date_schedule <![CDATA[<=]]>
		#{date_schedule_to}
		and s.break_shift = 1
		and d.shift = s.id and
		d.id_user = #{id_user}
	</select>


	<select id="timeWorkedProgram" resultType="int" parameterType="map">
		select
		sum(d_1.time)
		from
		schedule s_1,
		detailinitialschedule d_1
		where
		s_1.user = #{id_user}
		and s_1.id =
		d_1.id_schedule
		and s_1.date_schedule <![CDATA[<=]]>
		#{date_schedule_to}
		and s_1.date_schedule <![CDATA[>=]]>
		#{date_schedule_from}
	</select>

	<select id="timeWorkedReviewd" resultType="int" parameterType="map">
		select
		sum(d_1.time)
		from
		schedule s_1,
		detailfinalschedule d_1
		where
		s_1.user = #{id_user}
		and s_1.id =
		d_1.id_schedule
		and s_1.date_schedule <![CDATA[<=]]>
		#{date_schedule_to}
		and s_1.date_schedule <![CDATA[>=]]>
		#{date_schedule_from}
	</select>


	<select id="dateAtWork" resultType="java.util.Date"
		parameterType="map">
		select
		s.date_schedule
		from
		schedule s,
		usershift us
		where
		s.date_schedule <![CDATA[<=]]>
		#{date_schedule_to}
		and s.date_schedule <![CDATA[>=]]>
		#{date_schedule_from}
		and s.user = #{id_user}
		and s.shift = us.id
		and
		us.presence = 1
		order by s.date_schedule asc
	</select>









	<select id="selectRateShiftByUserProgram" resultType="org.uario.seaworkengine.statistics.RateShift"
		parameterType="map">
		select
		d_1.shift,
		sum(d_1.time) / (select
		sum(d_2.time) as global_sum
		from
		schedule s_2,
		detailinitialschedule d_2
		where
		s_2.user = #{id_user}
		and
		s_2.id =
		d_2.id_schedule
		and s_2.date_schedule <![CDATA[<=]]>
		#{date_schedule}) * 100 as rate
		from
		schedule s_1,
		detailinitialschedule
		d_1
		where
		s_1.user = #{id_user}
		and s_1.id = d_1.id_schedule
		and
		s_1.date_schedule <![CDATA[<=]]>
		#{date_schedule}
		group by d_1.shift
		order by rate asc

	</select>

	<select id="selectRateShiftByUserReviewd" resultType="org.uario.seaworkengine.statistics.RateShift"
		parameterType="map">
		select
		d_1.shift,
		sum(d_1.time) / (select
		sum(d_2.time) as global_sum
		from
		schedule s_2,
		detailfinalschedule d_2
		where
		s_2.user = #{id_user}
		and
		s_2.id =
		d_2.id_schedule
		and s_2.date_schedule <![CDATA[<=]]>
		#{date_schedule}) * 100 as rate
		from
		schedule s_1,
		detailfinalschedule
		d_1
		where
		s_1.user = #{id_user}
		and s_1.id = d_1.id_schedule
		and
		s_1.date_schedule <![CDATA[<=]]>
		#{date_schedule}
		group by d_1.shift
		order by rate asc

	</select>

	<select id="selectPercentageSunday" resultType="double"
		parameterType="map">
		select
		count(ds.user) / (select
		count(dd.user)
		from
		schedule dd,
		usershift uu
		where
		DAYOFWEEK(dd.date_schedule) = 1 and
		uu.presence = 1 and dd.shift =
		uu.id) * 100 as perc
		from
		schedule ds,
		usershift us
		where
		ds.shift =
		us.id and us.presence = 1
		and
		DAYOFWEEK(ds.date_schedule) = 1 and ds.user = #{id_user}
	</select>

	<select id="selectPercentageSundayAndHoliday" resultType="double">
		select
		count(s.id) / (select
		count(s.id)
		from
		schedule s,
		usershift us
		where
		s.shift = us.id and us.presence = 1
		and (date_format(s.date_schedule,
		'%m-%d') in ('01-01' , '01-06',
		'04-25',
		'05-01',
		'06-02',
		'08-15',
		'11-01',
		'12-08',
		'12-25',
		'12-26'
		'08-13')
		or DAYOFWEEK(s.date_schedule) =
		1)) * 100 as perc
		from
		schedule s,
		usershift us
		where
		s.user = #{id_user}
		and s.shift = us.id
		and us.presence = 1
		and
		(date_format(s.date_schedule, '%m-%d') in ('01-01' , '01-06',
		'04-25',
		'05-01',
		'06-02',
		'08-15',
		'11-01',
		'12-08',
		'12-25',
		'12-26',
		'08-13')
		or
		DAYOFWEEK(s.date_schedule) = 1)

	</select>



</mapper>